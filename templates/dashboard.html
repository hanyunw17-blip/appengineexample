{% extends "base.html" %}

{% block title %}AMG Configurator - Control Center{% endblock %}

{% block content %}
<div class="container-fluid fadeInUp" style="padding: 2rem 5%;">
    <div class="d-flex justify-content-between align-items-end mb-4" style="border-bottom: 2px solid #333; padding-bottom: 1.5rem;">
        <div>
            <h6 class="text-uppercase" style="color: #d1001a; letter-spacing: 2px; margin-bottom: 0.5rem;">Member Profile</h6>
            <h2 style="color: #fff; margin: 0; font-weight: 700;">Pilot: <span style="color: #f8f9fa;">{{ session.username }}</span></h2>
        </div>
        <div class="text-right">
            <h6 class="text-uppercase" style="color: #888; letter-spacing: 1px; margin-bottom: 0.5rem;">Total Investment</h6>
            <h1 id="totalPrice" style="color: #d1001a; margin: 0; font-weight: 900; font-size: 3rem;">$0</h1>
        </div>
    </div>

    <div class="progress-container mb-5">
        <div class="d-flex justify-content-between" id="stepIndicator"></div>
    </div>

    <div class="row g-5">
        <div class="col-lg-7">
            <div class="card-glassmorphism shadow-lg" style="position: sticky; top: 100px; padding: 20px; border-radius: 15px; background: rgba(255,255,255,0.03);">
                <div id="preview-container" style="min-height: 400px; display: flex; align-items: center; justify-content: center;">
                    <img id="main-car-image" src="" class="img-fluid rounded" style="transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 20px 30px rgba(0,0,0,0.5));" alt="AMG Preview">
                </div>
                <div class="text-center mt-3">
                    <span class="badge" style="background: #d1001a; padding: 8px 20px; border-radius: 50px; font-weight: 600; letter-spacing: 1px;">AMG REAL-TIME VISUALIZER</span>
                </div>
            </div>
        </div>

        <div class="col-lg-5">
            <div id="config-panel" style="min-height: 500px;">
                <div id="step-content"></div>
            </div>

            <div class="d-flex justify-content-between mt-5 pt-4" style="border-top: 1px solid #333;">
                <button id="prevBtn" class="btn btn-outline-light px-4 py-2" onclick="changeStep(-1)" style="border-radius: 0; display: none;">BACK</button>
                <button id="nextBtn" class="btn btn-gradient btn-3d px-5 py-2" onclick="changeStep(1)" disabled style="margin-left: auto;">CONTINUE</button>
            </div>
        </div>
    </div>
</div>

<style>
    .progress-step { flex: 1; text-align: center; position: relative; color: #555; font-size: 0.75rem; font-weight: 800; transition: 0.3s; }
    .progress-step.active { color: #fff; }
    .progress-step.active::after { background: #d1001a; box-shadow: 0 0 15px #d1001a; transform: scale(1.2); }
    .progress-step::after { content: ''; display: block; width: 10px; height: 10px; background: #333; border-radius: 50%; margin: 10px auto; transition: 0.4s; }
    
    .option-item { 
        background: rgba(40,40,40,0.4); border: 1px solid #333; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer; transition: 0.3s; 
    }
    .option-item:hover { border-color: #666; transform: translateX(5px); }
    .option-item.selected { border-left: 5px solid #d1001a; background: rgba(209, 0, 26, 0.15); border-color: #d1001a; }
    
    .color-circle { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #444; margin-right: 15px; display: inline-block; vertical-align: middle; }
    
    #main-car-image.loading { opacity: 0.3; transform: scale(0.95); }
</style>

<script>
    const mockData = {
        steps: ['MODEL', 'TRIM', 'COLOR', 'WHEELS', 'INTERIOR', 'SUMMARY'],
        models: [
            { id: 'gt63', name: 'AMG GT 63 S E Performance', basePrice: 180500, image: 'https://images.unsplash.com/photo-1617814076367-b759c7d7e738?auto=format&fit=crop&w=1200' },
            { id: 'c63', name: 'AMG C 63 S Performance', basePrice: 83900, image: 'https://images.unsplash.com/photo-1618843479313-40f8afb4b4d8?auto=format&fit=crop&w=1200' },
            { id: 'sl63', name: 'AMG SL 63 Roadster', basePrice: 178100, image: 'https://images.unsplash.com/photo-1580273916550-e323be2ae537?auto=format&fit=crop&w=1200' }
        ],
        trims: [
            { id: 'standard', name: 'Standard Edition', price: 0, desc: 'Base performance setup' },
            { id: 'night', name: 'AMG Night Package', price: 2500, desc: 'High-gloss black accents' },
            { id: 'carbon', name: 'Carbon Fiber Package', price: 7300, desc: 'Lightweight carbon aero components' }
        ],
        colors: [
            { id: 'obsidian', name: 'Obsidian Black', hex: '#000000', price: 0, img: 'https://images.unsplash.com/photo-1617814076367-b759c7d7e738?auto=format&fit=crop&w=1200' },
            { id: 'magno', name: 'Selenite Grey Magno', hex: '#4b4b4b', price: 3250, img: 'https://images.unsplash.com/photo-1606664515524-ed2f786a0bd6?auto=format&fit=crop&w=1200' },
            { id: 'red', name: 'Jupiter Red', hex: '#8b0000', price: 1500, img: 'https://images.unsplash.com/photo-1583121274602-3e2820c69888?auto=format&fit=crop&w=1200' }
        ],
        wheels: [
            { id: 'w19', name: '19" AMG 10-Spoke', price: 0 },
            { id: 'w21', name: '21" AMG Forged Cross-Spoke Black', price: 4150 }
        ],
        interiors: [
            { id: 'black', name: 'Black Nappa Leather', price: 0 },
            { id: 'red_pepper', name: 'Red Pepper/Black Nappa', price: 2800 }
        ]
    };

    let currentStepIdx = 0;
    let config = { model: null, trim: null, color: null, wheels: null, interior: null };

    function init() {
        renderStepIndicator();
        renderCurrentStep();
        updateUI();
    }

    function renderStepIndicator() {
        const container = document.getElementById('stepIndicator');
        container.innerHTML = mockData.steps.map((s, i) => `
            <div class="progress-step ${i === currentStepIdx ? 'active' : ''}">${s}</div>
        `).join('');
    }

    function renderCurrentStep() {
        const content = document.getElementById('step-content');
        const stepKey = mockData.steps[currentStepIdx].toLowerCase();
        let html = `<h3 class="mb-4 text-uppercase fw-bold" style="letter-spacing:1px;">Select ${stepKey}</h3>`;

        if (stepKey === 'model') {
            html += mockData.models.map(m => `
                <div class="option-item ${config.model?.id === m.id ? 'selected' : ''}" onclick="selectItem('model', '${m.id}')">
                    <div class="d-flex justify-content-between">
                        <strong>${m.name}</strong>
                        <span class="text-danger">$${m.basePrice.toLocaleString()}</span>
                    </div>
                </div>
            `).join('');
        } else if (stepKey === 'trim') {
            html += mockData.trims.map(t => `
                <div class="option-item ${config.trim?.id === t.id ? 'selected' : ''}" onclick="selectItem('trim', '${t.id}')">
                    <strong>${t.name}</strong><br><small class="text-muted">${t.desc}</small>
                    <div class="text-danger mt-1">+$${t.price.toLocaleString()}</div>
                </div>
            `).join('');
        } else if (stepKey === 'color') {
            html += mockData.colors.map(c => `
                <div class="option-item ${config.color?.id === c.id ? 'selected' : ''}" onclick="selectItem('color', '${c.id}')">
                    <span class="color-circle" style="background:${c.hex}"></span>
                    <strong>${c.name}</strong>
                    <span class="float-end text-danger">+$${c.price.toLocaleString()}</span>
                </div>
            `).join('');
        } else if (stepKey === 'summary') {
            html = `<h3 class="mb-4 text-uppercase fw-bold">Configuration Complete</h3>
                    <div class="card-glassmorphism p-4" style="background:rgba(255,255,255,0.05)">
                        <p>Model: ${config.model.name}</p>
                        <p>Trim: ${config.trim.name}</p>
                        <p>Color: ${config.color.name}</p>
                        <p>Wheels: ${config.wheels.name}</p>
                        <p>Interior: ${config.interior.name}</p>
                        <hr style="border-color:#444">
                        <button class="btn btn-danger w-100 py-3 mt-2" onclick="alert('Configuration Saved!')">SEND TO DEALERSHIP</button>
                    </div>`;
        } else {
            const items = mockData[stepKey + (stepKey === 'wheels' ? '' : 's')];
            html += items.map(item => `
                <div class="option-item ${config[stepKey]?.id === item.id ? 'selected' : ''}" onclick="selectItem('${stepKey}', '${item.id}')">
                    <strong>${item.name}</strong>
                    <span class="float-end text-danger">+$${item.price.toLocaleString()}</span>
                </div>
            `).join('');
        }
        content.innerHTML = html;
    }

    function selectItem(type, id) {
        let source = mockData[type + (type === 'model' || type === 'color' || type === 'trim' ? 's' : (type === 'wheels' ? '' : 's'))];
        config[type] = source.find(item => item.id === id);
        
        if (type === 'model' || type === 'color') {
            const imgEl = document.getElementById('main-car-image');
            imgEl.classList.add('loading');
            setTimeout(() => {
                imgEl.src = config.color?.img || config.model?.image;
                imgEl.classList.remove('loading');
            }, 300);
        }
        
        updateUI();
        renderCurrentStep();
    }

    function changeStep(dir) {
        currentStepIdx += dir;
        renderStepIndicator();
        renderCurrentStep();
        updateUI();
    }

    function updateUI() {
        let total = 0;
        if (config.model) total += config.model.basePrice;
        if (config.trim) total += config.trim.price;
        if (config.color) total += config.color.price;
        if (config.wheels) total += config.wheels.price;
        if (config.interior) total += config.interior.price;
        document.getElementById('totalPrice').innerText = '$' + total.toLocaleString();

        document.getElementById('prevBtn').style.display = currentStepIdx > 0 ? 'block' : 'none';
        const nextBtn = document.getElementById('nextBtn');
        
        const currentKey = mockData.steps[currentStepIdx].toLowerCase();
        const isSelected = currentKey === 'summary' ? true : !!config[currentKey];
        nextBtn.disabled = !isSelected;
        nextBtn.innerText = currentStepIdx === mockData.steps.length - 1 ? 'FINISH' : 'CONTINUE';
        
        if (!document.getElementById('main-car-image').src && config.model) {
            document.getElementById('main-car-image').src = config.model.image;
        }
    }

    window.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}
